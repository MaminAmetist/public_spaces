{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта Москвы</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #map { flex: 1; height: 100%; }
        #sidebar {
            width: 0;
            transition: width 0.3s ease;
            overflow-y: auto;
            background-color: #f9f9f9;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            padding: 20px;
        }
        #sidebar.open { width: 380px; }
        #sidebar img { width: 100%; border-radius: 10px; margin-bottom: 15px; }
        #closeSidebar {
            background: none; border: none; font-size: 22px; cursor: pointer; float: right;
        }
    </style>
</head>
<body>
<div id="map"></div>

<div id="sidebar">
    <button id="closeSidebar">&times;</button>
    <h2 id="placeTitle">Название места</h2>
    <img id="placeImage" src="" alt="Фото места">
    <p id="placeDescription"></p>
</div>

<!-- Безопасный JSON -->
{{ places|json_script:"places-data" }}

<script>
    const placesData = JSON.parse(document.getElementById('places-data').textContent);

    var map = L.map('map').setView([55.7558, 37.6173], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('placeTitle');
    const image = document.getElementById('placeImage');
    const desc = document.getElementById('placeDescription');
    const closeBtn = document.getElementById('closeSidebar');

    function openSidebar(place) {
        title.textContent = place.title;
        image.src = place.image ? place.image : "{% static 'main/images/no-image.jpg' %}";
        desc.textContent = place.description;
        sidebar.classList.add('open');
    }

    closeBtn.addEventListener('click', () => sidebar.classList.remove('open'));

    placesData.forEach(place => {
        if (place.latitude && place.longitude) {
            const marker = L.marker([place.latitude, place.longitude]).addTo(map);
            marker.bindTooltip(place.title, { direction: 'top', offset: [0, -10] });
            marker.on('click', () => openSidebar(place));
        }
    });
</script>
</body>
</html>
